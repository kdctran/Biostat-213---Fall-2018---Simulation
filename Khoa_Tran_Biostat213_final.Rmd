---
title: "Biostats 213 Final"
author: Khoa Tran
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

if (!"adaptMCMC" %in% rownames(installed.packages()))  
    install.packages("adaptMCMC", repos = "http://cran.rstudio.com/")
if (!"coda" %in% rownames(installed.packages()))  
    install.packages("coda", repos = "http://cran.rstudio.com/")

library(adaptMCMC)
library(coda)
```

### INTRODUCTION

The two dimensional Banana distribution (Haario, 1999) is defined as:  

$$
\pi (x_1, x_2) \propto e^{\frac{-x_1^2}{2}} e^{\frac{-(x_2 - 2(x_1^2 - 5))^2}{2}}
$$

### METHODS
#### Describe how to simulate directly from $\pi (x_1, x_2)$ 

* Use Metropolis algorithm to sample from the log density $\frac{-x_1^2}{2} - \frac{(x_2 - 2(x_1^2 - 5))^2}{2}$  
* Function `MCMC` from package `adaptMCMC`

#### Sample from log pdf $\frac{-x_1^2}{2} - \frac{(x_2 - 2(x_1^2 - 5))^2}{2}$

```{r, include=T}
## log-pdf to sample from
log.pdf <- function(x) {
  -x[1]^2/2 - 1/2*(x[2]-2*x[1]^2+10)^2
}

## generate sample
set.seed(213)

## generate N samples
N <- 100000

sample1 <- MCMC(log.pdf, n = N, init = c(0, 0), 
                scale = c(1, 0.5), adapt=FALSE)

sample1.mcmc <- mcmc(sample1$samples)
```

```{r}
summary(sample1.mcmc)
plot(sample1.mcmc)
```
```{r}
sample1.trace <- sample1.mcmc[0:200, ]
plot(sample1.trace, xlim = c(-5, 5), ylim = c(-5, 5), col = 1:200)
lines(sample1.trace)
```

* Image of $e^{\frac{-x_1^2}{2}} e^{\frac{-(x_2 - 2(x_1^2 - 5))^2}{2}}$

```{r, include=FALSE}
x1 <- seq(-15, 15, length = 100)
x2 <- seq(-15, 15, length = 100)
banana.dist <- matrix(apply(expand.grid(x1, x2), 1, log.pdf), nrow = 100)

image(x1, x2, exp(banana.dist), col = cm.colors(60), xlim = c(-10, 10))
```

* Sample result:

```{r, include=FALSE}
image(x1, x2, exp(banana.dist), col = cm.colors(60), xlim = c(-10, 10))
points(sample1$samples, pch=1)
```

* More graphs:

```{r, include=FALSE}
tab1 <- sample1$samples
par(mfrow=c(3,2))
plot(tab1,col=1:N, xlim = c(-10, 10), ylim = c(-15, 15))
plot(tab1,type="l")
plot(ts(tab1[,1]))
plot(ts(tab1[,2]))
hist(tab1[,1],40)
hist(tab1[,2],40)
par(mfrow=c(1,1))
```


#### Diagnostic

```{r}
## More samples with different variance

## jumpsize w = 1
sample2 <- MCMC(log.pdf, n = N, init = c(0, 0), scale = c(1, 1),
               adapt=FALSE)

## jumpsize w = 2
sample3 <- MCMC(log.pdf, n = N, init = c(0, 0), scale = c(1, 2),
               adapt=FALSE)

## getting (x, y) from samples
sample1.mcmc <- sample1$samples
sample2.mcmc <- sample2$samples
sample3.mcmc <- sample3$samples

## discard burn-in, N = number iterations
burn <- 25000
sample1.burned <- mcmc(sample1.mcmc[burn:N, ])
sample2.burned <- mcmc(sample2.mcmc[burn:N, ]) 
sample3.burned <- mcmc(sample3.mcmc[burn:N, ]) 


# plot(ts(sample1$samples))
# plot(ts(sample2$samples))
# plot(ts(sample3$samples))

```
```{r}
plot(sample1.mcmc)
plot(sampl1.burned)
```

* Geweke test (if Geweke z-score is > 2, not at stationary distribution yet):

```{r}


## geweke z-score
geweke1 <- geweke.diag(sample1.burned , frac1 = 0.5, frac2 = 0.2)
geweke2 <- geweke.diag(sample2.burned , frac1 = 0.5, frac2 = 0.2)
geweke3 <- geweke.diag(sample3.burned , frac1 = 0.5, frac2 = 0.2)

geweke1
geweke2
geweke3
```



* Raftery-Lewis test:

```{r}
raftery.diag(sample1.burned, q = 0.025, r = 0.005, s = 0.95, converge.eps = 0.001)
raftery.diag(sample2.burned, q = 0.025, r = 0.005, s = 0.95, converge.eps = 0.001)
raftery.diag(sample3.burned, q = 0.025, r = 0.005, s = 0.95, converge.eps = 0.001)
```

* Heidelberg & Welch test:

```{r}
heidel.diag(sample1.burned, eps = 0.1, pvalue = 0.05)
heidel.diag(sample2.burned, eps = 0.1, pvalue = 0.05)
heidel.diag(sample3.burned, eps = 0.1, pvalue = 0.05)
```